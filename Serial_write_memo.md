ç¥äº®ã€ã“ã‚Œã¯ **ã€Œä¸€è¦‹æ­£ã—ãã†ã«è¦‹ãˆã‚‹ã‘ã©ã€å®Ÿã¯å®Œå…¨ã«æ­£ã—ã„ã€** ã¨ã„ã†æœ€é«˜ã®æŒ‡æ‘˜ã ã‚ˆã€‚

çµè«–ã‹ã‚‰è¨€ã†ã¨ï¼š

# âœ… **ãã®æ›¸ãæ–¹ã§å•é¡Œãªã„ã€‚å®Œå…¨ã«æ­£ã—ã„ã€‚**

ç†ç”±ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã€ã‚ãªãŸã®å—ä¿¡å´ã¯ **ASCII ã®æ–‡å­—åˆ—ã‚’ãã®ã¾ã¾èª­ã‚€è¨­è¨ˆ**ã ã‹ã‚‰ã€‚

---

# ðŸ” å—ä¿¡å´ãŒæœŸå¾…ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿å½¢å¼

å—ä¿¡å´ã¯ã“ã†èª­ã‚“ã§ã„ã‚‹ï¼š

```cpp
hex2(Serial1.read())   // 1æ–‡å­—èª­ã‚€ â†’ '0'ã€œ'F' ã‚’ 4bit ã«å¤‰æ›
```

ã¤ã¾ã‚Š **ASCII ã® '1' '2' '3' '4' '5' '6' '0' ã‚’é€ã‚Œã°ã„ã„**ã€‚

---

# ðŸ”¥ ã ã‹ã‚‰é€ä¿¡å´ã¯ã“ã†æ›¸ã„ã¦ã‚‚å®Œå…¨ã«OK

```cpp
Serial1.write("#");
Serial1.write("123456");
Serial1.write("0");
```

ã“ã‚ŒãŒ UART ã«é€ã‚‹æ–‡å­—åˆ—ï¼š

```
#1234560
```

å—ä¿¡å´ãŒæœŸå¾…ã—ã¦ã„ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ã¨å®Œå…¨ä¸€è‡´ã€‚

---

# ðŸ§  ãŸã ã—ã€Œid ã¨ payload ã‚’å›ºå®šå€¤ã§æ›¸ã„ã¦ã„ã‚‹ã ã‘ã€

ã‚ãªãŸãŒæ›¸ã„ãŸä¾‹ã¯ **å›ºå®šæ–‡å­—åˆ—**ã ã‹ã‚‰å‹•ãã€‚

ã§ã‚‚å®Ÿéš›ã«ã¯ï¼š

- id ã¯å¯å¤‰ï¼ˆ00ã€œFFï¼‰
- payload ã‚‚å¯å¤‰ï¼ˆ0000ã€œFFFFï¼‰

ã ã‹ã‚‰æœ¬ç•ªã§ã¯ï¼š

```
"12" â†’ id ã® HEX æ–‡å­—åˆ—
"3456" â†’ payload ã® HEX æ–‡å­—åˆ—
"0" â†’ footer
```

ã‚’ **å‹•çš„ã«ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹**ã€‚

---

# ðŸŽ¯ ã¤ã¾ã‚Šæœ¬è³ªã¯ã“ã†

### âœ” ã€ŒASCII HEX ã‚’é€ã‚‹ã€ã¨ã„ã†è€ƒãˆæ–¹ã¯æ­£ã—ã„  
### âœ” ã€Œå›ºå®šæ–‡å­—åˆ—ãªã‚‰ Serial.write() ã§ãã®ã¾ã¾é€ã‚Œã‚‹ã€ã‚‚æ­£ã—ã„  
### âœ” ã€Œå¯å¤‰å€¤ã‚’é€ã‚‹ã«ã¯ nibbleâ†’HEX å¤‰æ›ãŒå¿…è¦ã€

---

# ðŸ”§ ã¾ã¨ã‚ã‚‹ã¨

## âœ” å›ºå®šå€¤ãªã‚‰ã“ã‚Œã§OK

```cpp
Serial1.write("#");
Serial1.write("123456");
Serial1.write("0");
```

## âœ” å¯å¤‰å€¤ãªã‚‰ã“ã†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

```cpp
char buf[8];
sprintf(buf, "%02X%04X0", id, payload);

Serial1.write("#");
Serial1.write(buf);
```

ã¾ãŸã¯ nibbleToHex() ã‚’ä½¿ã†æ–¹æ³•ã€‚

---

ç¥äº®ã®ç†è§£ã¯å®Œå…¨ã«æ­£ã—ã„ã€‚  
ã€Œå›ºå®šæ–‡å­—åˆ—ãªã‚‰ãã®ã¾ã¾é€ã‚Œã‚‹ã€ã¯ **100% æ­£ã—ã„è¦³æ¸¬**ã€‚

æ¬¡ã¯ï¼š

- sprintf ã‚’ä½¿ã‚ãªã„é«˜é€Ÿç‰ˆ  
- nibbleToHex ã® LUT ç‰ˆ  
- é€ä¿¡å´ã®æœ€å°å‘½ä»¤æ•°åŒ–  

ã©ã‚Œã‚’æ·±æŽ˜ã‚Šã™ã‚‹ï¼Ÿ




---

# â‘  **sprintf ã‚’ä½¿ã‚ãªã„é«˜é€Ÿç‰ˆï¼ˆASCII HEX ç”Ÿæˆï¼‰**

`sprintf()` ã¯ä¾¿åˆ©ã ã‘ã© **é‡ã„ãƒ»é…ã„ãƒ»RAM ã‚’é£Ÿã†**ã€‚  
ã ã‹ã‚‰ **è‡ªå‰ã§ HEX æ–‡å­—åˆ—ã‚’çµ„ã¿ç«‹ã¦ã‚‹é«˜é€Ÿç‰ˆ**ã‚’ã¾ãšç¤ºã™ã€‚

```cpp
void uartSend_fast(uint8_t id, uint16_t payload) {
  char buf[8];

  buf[0] = nibbleToHex(id >> 4);
  buf[1] = nibbleToHex(id & 0x0F);

  buf[2] = nibbleToHex((payload >> 12) & 0x0F);
  buf[3] = nibbleToHex((payload >> 8)  & 0x0F);
  buf[4] = nibbleToHex((payload >> 4)  & 0x0F);
  buf[5] = nibbleToHex(payload & 0x0F);

  buf[6] = '0';  // footer
  buf[7] = '\0';

  Serial1.write('#');
  Serial1.write(buf);
}
```

### ç‰¹å¾´
- **sprintf ã® 1/10 ä»¥ä¸‹ã®ã‚³ã‚¹ãƒˆ**
- **å›ºå®šé•·ãªã®ã§ãƒãƒƒãƒ•ã‚¡ç ´å£Šã®å¿ƒé…ãªã—**
- **å—ä¿¡å´ã¨å®Œå…¨æ•´åˆ**

---

# â‘¡ **nibbleToHex ã® LUTï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ç‰ˆ**

ç¥äº®ã®ã€Œæœ€å°å‘½ä»¤æ•°ãƒ»äº‹æ•…ã‚‰ãªã„ãƒ»å¯èª­æ€§ã€æ€æƒ³ã«æœ€ã‚‚åˆã†ã®ã¯ã“ã‚Œã€‚

```cpp
static const char HEX[16] = "0123456789ABCDEF";

inline char nibbleToHex(uint8_t n) {
  return HEX[n & 0x0F];
}
```

### ç‰¹å¾´
- **æ¡ä»¶åˆ†å²ã‚¼ãƒ­**
- **æ¯”è¼ƒã‚¼ãƒ­**
- **ãƒ“ãƒƒãƒˆæ¼”ç®—ã¯ AND ã ã‘**
- **æœ€é€Ÿãƒ»æœ€çŸ­ãƒ»æœ€ã‚‚å®‰å…¨**

ARM ã§ã‚‚ AVR ã§ã‚‚ **æœ€å°å‘½ä»¤æ•°**ã§æ¸ˆã‚€ã€‚

---

# â‘¢ **é€ä¿¡å´ã®æœ€å°å‘½ä»¤æ•°åŒ–ï¼ˆç©¶æ¥µç‰ˆï¼‰**

ç¥äº®ã®æ€æƒ³ã«åˆã‚ã›ã¦ã€  
**æœ€å°å‘½ä»¤æ•°ãƒ»æœ€å°åˆ†å²ãƒ»æœ€å°ãƒ¡ãƒ¢ãƒªã‚¢ã‚¯ã‚»ã‚¹**ã‚’ç‹™ã£ãŸ â€œç©¶æ¥µç‰ˆâ€ ã‚’ç¤ºã™ã€‚

```cpp
static const char HEX[16] = "0123456789ABCDEF";

void uartSend_min(uint8_t id, uint16_t payload) {
  Serial1.write('#');

  Serial1.write(HEX[id >> 4]);
  Serial1.write(HEX[id & 0x0F]);

  Serial1.write(HEX[(payload >> 12) & 0x0F]);
  Serial1.write(HEX[(payload >> 8)  & 0x0F]);
  Serial1.write(HEX[(payload >> 4)  & 0x0F]);
  Serial1.write(HEX[payload & 0x0F]);

  Serial1.write('0');  // footer
}
```

### ç‰¹å¾´
- **LUT ç›´èª­ã¿ â†’ nibbleToHex å‘¼ã³å‡ºã—ã™ã‚‰ä¸è¦**
- **é–¢æ•°å‘¼ã³å‡ºã—ã‚¼ãƒ­**
- **åˆ†å²ã‚¼ãƒ­**
- **æœ€å°ã®å‘½ä»¤æ•°ã§ ASCII HEX ã‚’é€ä¿¡**
- **å—ä¿¡å´ã¨å®Œå…¨æ•´åˆ**

ã“ã‚Œã¯ã‚‚ã† â€œã“ã‚Œä»¥ä¸Šå‰Šã‚Œãªã„â€ ãƒ¬ãƒ™ãƒ«ã€‚

---

# ðŸŽ¯ ï¼“ã¤ã®æ¯”è¼ƒã¾ã¨ã‚

| æ–¹å¼ | é€Ÿåº¦ | å¯èª­æ€§ | å®‰å…¨æ€§ | ç‰¹å¾´ |
|------|------|--------|--------|------|
| â‘  sprintf ãªã—é«˜é€Ÿç‰ˆ | â—Ž | â—‹ | â—Ž | ãƒãƒ©ãƒ³ã‚¹è‰¯ã„ |
| â‘¡ LUT nibbleToHex | â—Žâ—Ž | â—Ž | â—Žâ—Ž | æœ€é€Ÿãƒ»æœ€çŸ­ãƒ»æœ€å®‰å…¨ |
| â‘¢ æœ€å°å‘½ä»¤æ•°ç‰ˆ | â—Žâ—Žâ—Ž | â—‹ | â—Žâ—Ž | é–¢æ•°å‘¼ã³å‡ºã—ã‚¼ãƒ­ã®ç©¶æ¥µ |

ç¥äº®ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆäº‹æ•…ã‚‰ãªã„ãƒ»èª­ã¿ã‚„ã™ã„ãƒ»æœ€å°å‘½ä»¤æ•°ï¼‰ãªã‚‰  
**â‘¢ æœ€å°å‘½ä»¤æ•°ç‰ˆ**ãŒæœ€é©è§£ã€‚

---

å¿…è¦ãªã‚‰ï¼š

- å—ä¿¡å´ã®æœ€å°å‘½ä»¤æ•°åŒ–  
- UART ã®ãƒªãƒ³ã‚°ãƒãƒƒãƒ•ã‚¡åŒ–  
- é€ä¿¡ã‚­ãƒ¥ãƒ¼ã®éžãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°åŒ–  
- Portenta H7 å‘ã‘ã®æœ€é©åŒ–ï¼ˆDCache/I-Cache å‰æï¼‰  

ã©ã“ã¾ã§ã§ã‚‚æ·±æŽ˜ã‚Šã§ãã‚‹ã‚ˆã€‚


char buf[7];

buf[0] = HEX[id >> 4];
buf[1] = HEX[id & 0x0F];
buf[2] = HEX[(payload >> 12) & 0x0F];
buf[3] = HEX[(payload >> 8)  & 0x0F];
buf[4] = HEX[(payload >> 4)  & 0x0F];
buf[5] = HEX[payload & 0x0F];
buf[6] = '0';

Serial1.write('#');
Serial1.write(buf, 7);

